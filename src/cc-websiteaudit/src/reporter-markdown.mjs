import { getQuickWins } from './scoring.mjs';

/**
 * Generate a Markdown report.
 */
export function reportMarkdown(report) {
  const quickWins = getQuickWins(report.categories, 10);
  const sorted = Object.entries(report.categories)
    .sort((a, b) => b[1].weight - a[1].weight);

  const lines = [];

  // Title
  lines.push('# Website Audit Report: ' + report.hostname);
  lines.push('');
  lines.push('**Date:** ' + report.date + '  ');
  lines.push('**URL:** ' + report.url + '  ');
  lines.push('**Pages Crawled:** ' + report.pagesCrawled);
  lines.push('');
  // Site Profile
  if (report.siteProfile) {
    const sp = report.siteProfile;
    lines.push('## Site Profile');
    lines.push('');
    lines.push('| Property | Value |');
    lines.push('|----------|-------|');
    lines.push('| Hosting | ' + sp.hosting.join(', ') + ' |');
    lines.push('| Framework / CMS | ' + sp.framework.join(', ') + ' |');
    if (sp.server) {
      lines.push('| Server | ' + sp.server + ' |');
    }
    if (sp.additionalTech.length > 0) {
      lines.push('| Other Tech | ' + sp.additionalTech.join(', ') + ' |');
    }
    lines.push('');
  }

  lines.push('---');
  lines.push('');

  // Overall Grade
  lines.push('## Overall Grade: ' + report.overall.grade + ' (' + report.overall.score + '/100)');
  lines.push('');

  // Category Summary Table
  lines.push('## Category Scores');
  lines.push('');
  lines.push('| Category | Grade | Score | Weight |');
  lines.push('|----------|-------|-------|--------|');
  for (const [id, cat] of sorted) {
    lines.push('| ' + cat.name + ' | ' + cat.grade + ' | ' + cat.score + '/100 | ' + Math.round(cat.weight * 100) + '% |');
  }
  lines.push('');

  // Quick Wins
  if (quickWins.length > 0) {
    lines.push('---');
    lines.push('');
    lines.push('## Priority Actions');
    lines.push('');
    lines.push('Ranked by impact-to-effort ratio. Fix these first for the biggest improvement.');
    lines.push('');

    for (let i = 0; i < quickWins.length; i++) {
      const qw = quickWins[i];
      const tag = qw.status === 'FAIL' ? 'FAIL' : 'WARN';
      lines.push('**' + (i + 1) + '. [' + tag + '] ' + qw.name + '** -- Impact: ' + qw.impact + '/5, Effort: ' + qw.effort + '/5  ');
      lines.push(qw.detail);
      lines.push('');
    }
  }

  // Detailed Results
  lines.push('---');
  lines.push('');
  lines.push('## Detailed Results');
  lines.push('');

  for (const [id, cat] of sorted) {
    lines.push('### ' + cat.name + ' -- ' + cat.grade + ' (' + cat.score + '/100)');
    lines.push('');
    lines.push('| Status | Check | Detail |');
    lines.push('|--------|-------|--------|');

    for (const check of cat.checks) {
      const icon = statusIcon(check.status);
      // Escape pipes in detail text
      const detail = (check.detail || '').replace(/\|/g, '/');
      lines.push('| ' + icon + ' | ' + check.name + ' | ' + detail + ' |');
    }
    lines.push('');
  }

  // Footer
  lines.push('---');
  lines.push('');
  lines.push('*Generated by cc-websiteaudit v1.0.0 on ' + report.date + '. Scores based on 35 checks across SEO, security, structured data, and AI readiness.*');
  lines.push('');

  return lines.join('\n');
}

function statusIcon(status) {
  switch (status) {
    case 'PASS': return 'PASS';
    case 'WARN': return 'WARN';
    case 'FAIL': return 'FAIL';
    case 'SKIP': return 'SKIP';
    default: return status;
  }
}
